<?xml version="1.0" encoding="utf-8"?>
<Page x:Class="CoolWear.Views.ProductsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:local="using:CoolWear.Views"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:models="using:CoolWear.Models"
      xmlns:viewmodels="using:CoolWear.ViewModels"
	  xmlns:converters="using:CoolWear.Converters"
      mc:Ignorable="d"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

	<Page.Resources>
		<converters:CurrencyFormatConverter x:Key="CurrencyFormatConverter"/>
		<!-- Converter used to HIDE the "No variants" message when count > 0 -->
		<converters:ZeroIsCollapsedConverter x:Key="ZeroIsCollapsedConverter"/>
		<Style x:Key="ListHeaderTextStyle" TargetType="TextBlock">
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="Margin" Value="0,0,5,0"/>
		</Style>
	</Page.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="220" />
			<ColumnDefinition Width="*" />
		</Grid.ColumnDefinitions>

		<!-- Filter Panel (Column 0) -->
		<ScrollViewer Grid.Column="0" Background="#F8F8F8" VerticalScrollBarVisibility="Auto">
			<StackPanel Padding="10" Spacing="16">
				<!-- Filter Controls -->
				<TextBlock Text="Nhóm hàng" FontWeight="Bold" />
				<ComboBox x:Name="NhomHangComboBox" PlaceholderText="Tất cả nhóm hàng" ItemsSource="{x:Bind ViewModel.Categories, Mode=OneWay}" SelectedItem="{x:Bind ViewModel.SelectedCategory, Mode=TwoWay}" HorizontalAlignment="Stretch">
					<ComboBox.ItemTemplate>
						<DataTemplate x:DataType="models:ProductCategory">
							<TextBlock Text="{x:Bind CategoryName}" />
						</DataTemplate>
					</ComboBox.ItemTemplate>
				</ComboBox>
				<TextBlock Text="Tồn kho" FontWeight="Bold" />
				<CheckBox Content="Còn hàng" IsChecked="{x:Bind ViewModel.FilterInStockOnly, Mode=TwoWay}" />
				<TextBlock Text="Size" FontWeight="Bold" />
				<ComboBox ItemsSource="{x:Bind ViewModel.Sizes, Mode=OneWay}" SelectedItem="{x:Bind ViewModel.SelectedSize, Mode=TwoWay}" PlaceholderText="Tất cả size" HorizontalAlignment="Stretch">
					<ComboBox.ItemTemplate>
						<DataTemplate x:DataType="models:ProductSize">
							<TextBlock Text="{x:Bind SizeName}" />
						</DataTemplate>
					</ComboBox.ItemTemplate>
				</ComboBox>
				<TextBlock Text="Màu sắc" FontWeight="Bold" />
				<ComboBox ItemsSource="{x:Bind ViewModel.Colors, Mode=OneWay}" SelectedItem="{x:Bind ViewModel.SelectedColor, Mode=TwoWay}" PlaceholderText="Tất cả màu sắc" HorizontalAlignment="Stretch">
					<ComboBox.ItemTemplate>
						<DataTemplate x:DataType="models:ProductColor">
							<StackPanel Orientation="Horizontal" Spacing="5">
								<TextBlock Text="{x:Bind ColorName}" />
							</StackPanel>
						</DataTemplate>
					</ComboBox.ItemTemplate>
				</ComboBox>
			</StackPanel>
		</ScrollViewer>

		<!-- Main Content Area (Column 1) -->
		<Grid Grid.Column="1">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto" />
				<!-- Toolbar -->
				<RowDefinition Height="Auto" />
				<!-- Static Header Row -->
				<RowDefinition Height="*" />
				<!-- ListView -->
			</Grid.RowDefinitions>

			<!-- Toolbar (Row 0) -->
			<StackPanel Orientation="Horizontal" Grid.Row="0" Padding="10" Spacing="8" Background="#EAEAEA">
				<!-- Toolbar Buttons -->
				<TextBox x:Name="SearchBox" Width="250" PlaceholderText="Tìm kiếm theo Tên hoặc Mã sản phẩm..." Text="{x:Bind ViewModel.SearchTerm, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,10,0" />
				<Button ToolTipService.ToolTip="Thêm sản phẩm mới" Command="{x:Bind ViewModel.AddProductCommand}">
					<StackPanel Orientation="Horizontal" Spacing="5">
						<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph=""/>
						<TextBlock Text="Thêm mới"/>
					</StackPanel>
				</Button>
				<Button ToolTipService.ToolTip="Nhập sản phẩm từ file Excel/CSV" Command="{x:Bind ViewModel.ImportProductsCommand}">
					<StackPanel Orientation="Horizontal" Spacing="5">
						<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph=""/>
						<TextBlock Text="Nhập file"/>
					</StackPanel>
				</Button>
				<Button ToolTipService.ToolTip="Xuất danh sách sản phẩm ra file" Command="{x:Bind ViewModel.ExportProductsCommand}">
					<StackPanel Orientation="Horizontal" Spacing="5">
						<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph=""/>
						<TextBlock Text="Xuất file"/>
					</StackPanel>
				</Button>
				<Button ToolTipService.ToolTip="Tải lại danh sách" Command="{x:Bind ViewModel.LoadProductsCommand}">
					<StackPanel Orientation="Horizontal" Spacing="5">
						<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph=""/>
						<TextBlock Text="Tải lại"/>
					</StackPanel>
				</Button>
			</StackPanel>

			<!-- Static Product List Header (Row 1) -->
			<!-- Padding Left=50 accounts for Image(40) + Margin(10) in rows below -->
			<Grid Grid.Row="1" Padding="50,5,10,5" Margin="10,5,10,0" Background="{ThemeResource SystemControlBackgroundListLowBrush}" BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,0,0,1">
				<Grid.ColumnDefinitions>
					<!-- Columns widths MUST match the Expander.Header grid below (excluding the image column) -->
					<ColumnDefinition Width="*" />
					<!-- Product Name -->
					<ColumnDefinition Width="150" />
					<!-- Category -->
					<ColumnDefinition Width="100" />
					<!-- Import Price -->
					<ColumnDefinition Width="100" />
					<!-- Price -->
					<ColumnDefinition Width="100" />
					<!-- Variants Count -->
					<ColumnDefinition Width="Auto" MinWidth="90"/>
					<!-- Actions -->
				</Grid.ColumnDefinitions>
				<!-- Header Text Blocks -->
				<TextBlock Grid.Column="0" Text="Tên sản phẩm" Style="{StaticResource ListHeaderTextStyle}"/>
				<TextBlock Grid.Column="1" Text="Nhóm hàng" Style="{StaticResource ListHeaderTextStyle}"/>
				<TextBlock Grid.Column="2" Text="Giá nhập" Style="{StaticResource ListHeaderTextStyle}" HorizontalAlignment="Right"/>
				<TextBlock Grid.Column="3" Text="Giá bán" Style="{StaticResource ListHeaderTextStyle}" HorizontalAlignment="Right"/>
				<TextBlock Grid.Column="4" Text="Phiên bản" Style="{StaticResource ListHeaderTextStyle}" HorizontalAlignment="Center"/>
				<TextBlock Grid.Column="5" Text="Thao tác" Style="{StaticResource ListHeaderTextStyle}" HorizontalAlignment="Center"/>
			</Grid>

			<!-- ListView (Row 2) -->
			<ListView x:Name="ItemsListView" Grid.Row="2" Margin="10,0,10,10" ItemsSource="{x:Bind ViewModel.FilteredProducts, Mode=OneWay}" SelectionMode="None" IsItemClickEnabled="False" ScrollViewer.VerticalScrollBarVisibility="Auto">
				<ListView.ItemTemplate>
					<DataTemplate x:DataType="models:Product">
						<Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" Margin="0,0,0,5" BorderThickness="0,0,0,1" BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}">
							<Expander.Header>
								<Grid ColumnSpacing="10" Padding="0,5">
									<Grid.ColumnDefinitions>
										<!-- Column Definitions MUST match Static Header structure (adding image column) -->
										<ColumnDefinition Width="40"/>
										<!-- 1. Image -->
										<ColumnDefinition Width="*" />
										<!-- 2. Product Name -->
										<ColumnDefinition Width="150" />
										<!-- 3. Category -->
										<ColumnDefinition Width="100" />
										<!-- 4. Import Price -->
										<ColumnDefinition Width="100" />
										<!-- 5. Price -->
										<ColumnDefinition Width="100" />
										<!-- 6. Variants Count -->
										<ColumnDefinition Width="Auto" MinWidth="90"/>
										<!-- 7. Actions -->
									</Grid.ColumnDefinitions>

									<!-- Column 1: Image -->
									<Image Grid.Column="0" Source="{x:Bind PublicId}" Width="40" Height="40" Stretch="UniformToFill" VerticalAlignment="Center"/>

									<!-- Column 2: Product Name -->
									<!-- Margin Left=10 creates space after image, aligns with Static Header's Padding -->
									<TextBlock Grid.Column="1" Text="{x:Bind ProductName}" FontWeight="SemiBold" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" ToolTipService.ToolTip="{x:Bind ProductName}" Margin="10,0,0,0"/>

									<!-- Column 3: Category -->
									<TextBlock Grid.Column="2" Text="{x:Bind Category.CategoryName}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" />

									<!-- Column 4: Import Price -->
									<TextBlock Grid.Column="3" Text="{x:Bind ImportPrice, Converter={StaticResource CurrencyFormatConverter}}" VerticalAlignment="Center" HorizontalAlignment="Right"/>

									<!-- Column 5: Selling Price -->
									<TextBlock Grid.Column="4" Text="{x:Bind Price, Converter={StaticResource CurrencyFormatConverter}}" VerticalAlignment="Center" HorizontalAlignment="Right"/>

									<!-- Column 6: Variants Count -->
									<TextBlock Grid.Column="5" VerticalAlignment="Center" HorizontalAlignment="Center">
                                         <Run Text="{x:Bind ProductVariants.Count}"/> <Run Text=" phiên bản"/>
									</TextBlock>

									<!-- Column 7: Actions -->
									<StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center" HorizontalAlignment="Center">
										<Button Padding="5" ToolTipService.ToolTip="Chỉnh sửa sản phẩm" Command="{Binding DataContext.EditProductCommand, ElementName=ItemsListView}" CommandParameter="{x:Bind}">
											<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="" FontSize="16"/>
										</Button>
										<Button Padding="5" ToolTipService.ToolTip="Xóa sản phẩm và tất cả phiên bản" Background="IndianRed" Command="{Binding DataContext.DeleteProductCommand, ElementName=ItemsListView}" CommandParameter="{x:Bind}">
											<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="" FontSize="16"/>
										</Button>
									</StackPanel>
								</Grid>
							</Expander.Header>

							<Expander.Content>
								<!-- Content Grid for Variants -->
								<Grid Margin="30,10,10,10">
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="*"/>
									</Grid.RowDefinitions>

									<!-- Variant Header -->
									<Grid Grid.Row="0" Padding="5" Margin="0,0,0,5" Background="{ThemeResource SystemControlBackgroundListLowBrush}">
										<!-- Variant Header Column Definitions -->
										<Grid.ColumnDefinitions>
											<ColumnDefinition Width="150"/>
											<ColumnDefinition Width="100"/>
											<ColumnDefinition Width="100"/>
											<ColumnDefinition Width="100"/>
											<ColumnDefinition Width="*"/>
											<ColumnDefinition Width="Auto"/>
										</Grid.ColumnDefinitions>
										<TextBlock Grid.Column="0" Text="Mã SKU" FontWeight="SemiBold"/>
										<TextBlock Grid.Column="1" Text="Màu sắc" FontWeight="SemiBold"/>
										<TextBlock Grid.Column="2" Text="Size" FontWeight="SemiBold"/>
										<TextBlock Grid.Column="3" Text="Tồn kho" FontWeight="SemiBold" HorizontalAlignment="Right"/>
										<TextBlock Grid.Column="5" Text="Thao tác" FontWeight="SemiBold" HorizontalAlignment="Right"/>
									</Grid>

									<!-- Variant Items Repeater -->
									<ItemsRepeater Grid.Row="1" ItemsSource="{x:Bind ProductVariants, Mode=OneWay}">
										<ItemsRepeater.ItemTemplate>
											<DataTemplate x:DataType="models:ProductVariant">
												<!-- Variant Row Grid -->
												<Grid Padding="5" BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}" BorderThickness="0,0,0,1">
													<!-- Variant Row Column Definitions -->
													<Grid.ColumnDefinitions>
														<ColumnDefinition Width="150"/>
														<ColumnDefinition Width="100"/>
														<ColumnDefinition Width="100"/>
														<ColumnDefinition Width="100"/>
														<ColumnDefinition Width="*"/>
														<ColumnDefinition Width="Auto"/>
													</Grid.ColumnDefinitions>
													<TextBlock Grid.Column="0" Text="{x:Bind VariantId}" VerticalAlignment="Center"/>
													<TextBlock Grid.Column="1" Text="{x:Bind Color.ColorName}" VerticalAlignment="Center"/>
													<TextBlock Grid.Column="2" Text="{x:Bind Size.SizeName}" VerticalAlignment="Center"/>
													<TextBlock Grid.Column="3" Text="{x:Bind StockQuantity}" VerticalAlignment="Center" HorizontalAlignment="Right"/>
													<StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center" HorizontalAlignment="Right">
														<Button Padding="5" ToolTipService.ToolTip="Chỉnh sửa phiên bản" Command="{Binding DataContext.EditVariantCommand, ElementName=ItemsListView}" CommandParameter="{x:Bind}">
															<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="" FontSize="14"/>
														</Button>
														<Button Padding="5" ToolTipService.ToolTip="Xóa phiên bản" Background="#FFE0E0" Command="{Binding DataContext.DeleteVariantCommand, ElementName=ItemsListView}" CommandParameter="{x:Bind}">
															<FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="" FontSize="14"/>
														</Button>
													</StackPanel>
												</Grid>
											</DataTemplate>
										</ItemsRepeater.ItemTemplate>
									</ItemsRepeater>

									<!-- "No Variants" Message TextBlock - HIDDEN when count > 0 -->
									<!-- Shows "Sản phẩm này chưa có phiên bản nào." -->
									<!-- Currently HIDDEN when variants ARE present (due to ZeroIsCollapsedConverter logic) -->
									<!-- Consider removing or using an *inverted* converter if you want this message ONLY when count is 0 -->
									<!--<TextBlock Text="Sản phẩm này chưa có phiên bản nào." Grid.Row="1" Visibility="{x:Bind ProductVariants.Count, Converter={StaticResource ZeroIsCollapsedConverter}, Mode=OneWay}" Margin="5" FontStyle="Italic"/>-->
								</Grid>
							</Expander.Content>
						</Expander>
					</DataTemplate>
				</ListView.ItemTemplate>
			</ListView>

			<!-- Overlays (Progress Ring / Empty Message) -->
			<ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}" VerticalAlignment="Center" HorizontalAlignment="Center" Width="50" Height="50" Grid.Row="2"/>
			<TextBlock Text="Không tìm thấy sản phẩm nào khớp với bộ lọc." Visibility="{x:Bind ViewModel.ShowEmptyMessage, Mode=OneWay}" VerticalAlignment="Center" HorizontalAlignment="Center" Grid.Row="2" Style="{ThemeResource BodyStrongTextBlockStyle}"/>

		</Grid>
	</Grid>
</Page>